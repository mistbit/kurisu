# Kurisu - 技术架构设计文档

## 1. 高层架构
系统采用 **面向微服务的单体 (Microservices-ready Monolith)** 架构。虽然目前为了简化开发和学习设计为模块化单体，但组件之间保持松耦合，以便未来可以拆分为独立的微服务（例如：独立的数据源服务、策略引擎、执行服务）。

### 架构分层
1.  **表现层 (Frontend)：** 用于监控、配置和 Agent 交互的交互式仪表盘。
2.  **API 网关 / 应用层 (Backend)：** 处理请求、认证和编排的 RESTful API 和 WebSocket 服务器。
3.  **领域层 (Core Logic)：**
    - **量化引擎：** 策略执行、回测、市场数据处理。
    - **AI Agent 核心：** LLM 集成、记忆管理、规划。
4.  **基础设施层 (Data & External)：** 数据库、交易所 API、LLM 提供商。

## 2. 技术栈

### 前端 (用户界面)
- **框架：** [Next.js](https://nextjs.org/) (React) - 用于服务端渲染和现代化路由。
- **语言：** TypeScript - 提供类型安全。
- **样式：** Tailwind CSS + ShadcnUI - 用于快速开发美观的 UI。
- **状态管理：** Zustand 或 TanStack Query。
- **图表：** Lightweight Charts (TradingView) 或 Recharts。

### 后端 (API & 核心逻辑)
- **框架：** [FastAPI](https://fastapi.tiangolo.com/) (Python) - 高性能、异步支持、自动生成文档。
- **语言：** Python 3.10+ - AI 和量化领域的标准语言。
- **任务队列：** Celery + Redis - 用于异步回测任务和定时作业。
- **数据处理：** Pandas, NumPy。
- **交易所接口：** [CCXT](https://github.com/ccxt/ccxt) - 支持 100+ 加密货币交易所的统一 API。

### AI & Agent 框架
- **编排：** [LangChain](https://www.langchain.com/) 或 [LangGraph](https://langchain-ai.github.io/langgraph/) - 用于构建有状态的 Agent。
- **LLM 接口：** OpenAI API / Anthropic / Ollama (本地)。
- **记忆 (RAG)：**
    - **向量存储：** [ChromaDB](https://www.trychroma.com/) 或 **pgvector** (PostgreSQL 扩展)。
    - **Embeddings：** OpenAI Embeddings 或 HuggingFace (本地)。

### 数据库 & 存储
- **关系型 & 时间序列：** [PostgreSQL](https://www.postgresql.org/) 配合 [TimescaleDB](https://www.timescale.com/) 扩展。
    - *原因：* 在一个地方高效存储 OHLCV 市场数据和结构化的交易记录。
- **缓存：** Redis - 用于实时市场数据缓存和发布/订阅 (Pub/Sub)。

## 3. 模块设计细节

### 3.1 数据摄入服务 (Data Ingestion)
- **职责：** 获取历史数据，流式传输实时 WebSocket 数据。
- **流程：** 交易所 API -> 标准化器 -> TimescaleDB / Redis。

### 3.2 策略引擎 (Strategy Engine - "量化大脑")
- **职责：** 计算指标，生成信号 (买入/卖出/持有)。
- **设计：** 抽象基类 `Strategy`，包含 `on_tick()`、`on_candle()` 方法。
- **回测：** 事件驱动的模拟引擎，使用历史数据验证逻辑。

### 3.3 执行服务 (Execution Service)
- **职责：** 订单管理 (OMS)、持仓跟踪、风控检查。
- **安全：** 实现 "模拟交易 (Paper Trading)" 模式与 "实盘 (Live)" 模式的切换。

### 3.4 AI Agent 服务 (AI Agent Service - "推理大脑")
- **组件：**
    - **规划器 (Planner)：** 分解用户目标（例如：“寻找 ETH 的低风险策略”）。
    - **工具 (Tools)：** 自定义工具用于查询数据库、运行回测或检查新闻。
    - **批评家 (Critic)：** 审查 LLM 生成的策略代码是否存在错误或逻辑缺陷。
- **工作流：** 用户查询 -> 规划器 -> 工具执行 -> 观察 -> 推理 -> 响应。

## 4. 目录结构规划
```
kurisu/
├── frontend/             # Next.js 应用程序
├── backend/              # FastAPI 应用程序
│   ├── app/
│   │   ├── api/          # API 路由 (v1)
│   │   ├── core/         # 配置、安全、数据库连接
│   │   ├── services/     # 业务逻辑 (MarketData, TradeExec)
│   │   ├── agents/       # AI Agent 逻辑 (Prompts, Tools, Memory)
│   │   ├── strategies/   # 策略实现
│   │   └── models/       # Pydantic & SQL 模型
│   └── tests/
├── data/                 # 本地数据存储 (docker volumes)
├── docs/                 # 项目文档
└── docker-compose.yml    # 容器编排
```

## 5. 开发路线图

### 第一阶段：基础设施 (第1-4周)
**目标：** 建立核心基础设施和基本功能。

| 周次 | 任务 | 交付成果 |
|------|-------|--------------|
| 1 | 项目搭建 | 仓库结构、Docker配置、Poetry/Node设置 |
| 2 | 数据库设计 | PostgreSQL + TimescaleDB架构、迁移、连接池 |
| 3 | 数据摄入 | CCXT集成、历史数据获取器、WebSocket流 |
| 4 | 基础API | FastAPI骨架、健康检查端点、数据库CRUD操作 |

**里程碑：** 可工作的数据管道，存储BTC/USDT OHLCV数据。

### 第二阶段：量化引擎 (第5-8周)
**目标：** 构建量化分析和回测能力。

| 周次 | 任务 | 交付成果 |
|------|-------|--------------|
| 5 | 策略框架 | 抽象`Strategy`类、指标库集成 |
| 6 | 回测引擎 | 事件驱动模拟器、订单匹配、滑点模型 |
| 7 | 性能指标 | 夏普比率、最大回撤、胜率计算 |
| 8 | 策略示例 | 移动平均交叉、RSI策略、网格交易 |

**里程碑：** 完成简单策略的回测并生成性能报告。

### 第三阶段：AI集成 (第9-12周)
**目标：** 集成LLM能力并构建认知代理。

| 周次 | 任务 | 交付成果 |
|------|-------|--------------|
| 9 | LLM集成 | OpenAI/Anthropic/Ollama连接器、提示模板 |
| 10 | Agent工具 | 市场数据工具、回测工具、分析工具 |
| 11 | 记忆系统 | 向量数据库设置、RAG实现 |
| 12 | Agent工作流 | LangGraph状态机、ReAct模式实现 |

**里程碑：** Agent能够分析市场数据并解释交易决策。

### 第四阶段：前端与用户体验 (第13-16周)
**目标：** 为所有功能构建直观的用户界面。

| 周次 | 任务 | 交付成果 |
|------|-------|--------------|
| 13 | 仪表盘 | 实时图表、投资组合概览、持仓监控 |
| 14 | Agent聊天 | 聊天界面、消息历史、代码高亮 |
| 15 | 回测实验室 | 策略配置、参数调优、结果可视化 |
| 16 | 策略编辑器 | Monaco编辑器集成、语法验证、保存/加载 |

**里程碑：** 所有核心功能的完整Web界面。

### 第五阶段：执行与风控 (第17-20周)
**目标：** 启用安全的模拟和实盘交易能力。

| 周次 | 任务 | 交付成果 |
|------|-------|--------------|
| 17 | 模拟交易 | 模拟订单执行、虚拟投资组合管理 |
| 18 | 风险管理 | 仓位限制、止损逻辑、熔断机制 |
| 19 | 实盘交易 | 交易所API集成、订单管理系统 |
| 20 | 监控 | 实时告警、性能跟踪、日志记录 |

**里程碑：** 具有可配置风险参数的安全模拟交易。

### 第六阶段：高级功能 (第21-24周)
**目标：** 增强Agent的高级能力。

| 周次 | 任务 | 交付成果 |
|------|-------|--------------|
| 21 | 策略生成 | 基于LLM的代码生成、语法验证 |
| 22 | 多Agent | Agent协作、角色化Agent |
| 23 | 自我改进 | 性能反馈循环、策略优化 |
| 24 | 文档 | API文档、用户指南、部署指南 |

**里程碑：** Agent能够根据反馈自主改进策略。

## 6. 技术债务与注意事项

### 安全性
- 所有API密钥必须存储在环境变量或安全保险库中
- 在所有公共端点实施速率限制
- 为敏感操作（实盘交易）添加身份验证

### 可扩展性
- 从一开始就为水平扩展设计
- 使用Redis缓存频繁访问的数据
- 随着负载增加考虑数据库读取副本

### 测试
- 所有核心业务逻辑的单元测试
- API端点的集成测试
- 关键用户流程的端到端测试
- 针对已知市场场景的回测验证

### 监控
- 带有关联ID的结构化日志
- 性能指标收集
- 错误跟踪和告警
- 数据库查询性能监控
